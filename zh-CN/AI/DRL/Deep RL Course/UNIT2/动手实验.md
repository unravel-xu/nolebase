# 动手实验

现在我们已经学完了 Q-Learning 算法，让我们从头开始实现它，并在两个环境中训练 Agent：

1. Frozen-Lake-v1（非滑动和滑动版本）：Agent 需要在起始状态（S）和目标状态（G）之间移动，且移动时仅能在冰冻的瓷砖（F）上行走不能掉入冰洞（H）
2. An autonomous taxi：需要学习在城市中将乘客从 A 点运输到 B 点

![[pic-20250316105549771.png]]

## 准备工作
### 🎮 环境:

- [FrozenLake-v1](https://gymnasium.farama.org/environments/toy_text/frozen_lake/)
- [Taxi-v3](https://gymnasium.farama.org/environments/toy_text/taxi/)

### 📚 RL-Library:

- Python and NumPy
- [Gymnasium](https://gymnasium.farama.org/)

### 安装依赖

- gymnasium: Contains the FrozenLake-v1 ⛄ and Taxi-v3 🚕 environments
- pygame：Used for the FrozenLake-v1 and Taxi-v3 UI
- numpy：用于处理 Q-table

```bash
!pip install -r https://raw.githubusercontent.com/huggingface/deep-rl-class/main/notebooks/unit2/requirements-unit2.txt
```

```bash
!sudo apt-get update
!sudo apt-get install -y python3-opengl
!apt install ffmpeg xvfb
!pip3 install pyvirtualdisplay
```

virtual screen 可能需要重启 notebook runtime，所以我们执行如下代码强制崩溃，colab 会自动重启，我们再从下一个 cell 开始运行

```python
import os
os.kill(os.getpid(), 9)
```

```python
# Virtual display
from pyvirtualdisplay import Display

virtual_display = Display(visible=0, size=(1400, 900))
virtual_display.start()
```

### 导入包

```python
import numpy as np
import gymnasium as gym
import random
import imageio	# 生成回放视频
import os
import tqdm

import pickle5 as pickle
from tqdm.notebook import tqdm
```

准备工作完成

## Part 1：Frozen Lake ⛄ (non slippery version)

### 创建并了解 [FrozenLake environment ⛄]((https://gymnasium.farama.org/environments/toy_text/frozen_lake/)

环境的[说明文档](https://www.google.com/url?q=https%3A%2F%2Fgymnasium.farama.org%2Fenvironments%2Ftoy_text%2Ffrozen_lake%2F)

有两种大小的环境：
- `map_name = "4x4"`：大小为 $4\times4$ 的网格
- `map_name = "8x8"`：大小为 $8\times8$ 的网格

环境有两种不同的模式：
- `is_slippery=False`：在 frozen lake 上不会滑动，Agent 可以按预期方向移动（确定的）
- `is_slippery=True`：在 frozen lake 上会打滑，Agent 可能不按预期方向移动（随机的）

现在我们用最简单的环境：大小为 $4\times4$ 且不会滑动的 frozen lake，添加一个名为 `render_mode` 的参数来指定环境可视化方式。我们希望最后录制环境的视频，需要设置 `render_mode = rgb_array`

[文档](https://gymnasium.farama.org/api/env/#gymnasium.Env.render) 解释了“rgb_array”：返回一个表示当前环境状态的单一帧。一个帧是一个 np.ndarray，其形状为 (x, y, 3)，表示一个 x 行 y 列像素图像的 RGB 值。